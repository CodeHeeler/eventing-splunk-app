<dashboard version="1.1">
  <label>Events</label>
  <search id="base_query">
    <query>
index=redhatinsights AND bundle = "rhel" 
| spath 
| rename object.* as *
| spath path=events{} output=events
| stats by timestamp, events, application, event_type, account_id, context.display_name,
| mvexpand events 
| eval _raw=events
| kv
| eval application = upper(substr(application,1,1)).substr(application,2)
| eval title=case(event_type=="new-recommendation",'payload.rule_description', event_type=="policy-triggered", 'payload.policy_name'." policy triggered", event_type=="drift-baseline-detected","Drift detected from ".'payload.baseline_name'."  baseline", !isnull(event_type), 'event_type') 
| eval time=strptime(timestamp, "%Y-%m-%dT%H:%M:%S.%3N")
| eval url = 'payload.rule_url'
| eval event_type = case(event_type=="new-recommendation", "New recommendation", event_type=="policy-triggered","Policy triggered", event_type=="drift-baseline-detected","Drift from baseline detected", !isnull(event_type), 'event_type')
| convert timeformat="%Y-%m-%d %H:%M:%S" ctime(time) AS created_at_fmt
| table created_at_fmt, account_id, "application", "event_type", "context.display_name", title, url
| sort -created_at_fmt
| rename account_id as "Account", created_at_fmt as "Timestamp", context.display_name as "System", context.host_url as "Host URL", event_type as "Event Type", "title" as "Description", "application" as "Application",  url as "Details"          

    </query>
    <earliest>$timepicker.earliest$</earliest>
    <latest>$timepicker.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="timepicker">
      <label>Timestamp</label>
      <default>
        <earliest></earliest>
        <latest></latest>
      </default>
    </input>
    <input type="dropdown" token="field_account" searchWhenChanged="true">
      <label>Account</label>
      <search base="base_query">
        <query>| stats count by "Account"</query>
      </search>
      <fieldForLabel>Account</fieldForLabel>
      <fieldForValue>Account</fieldForValue>
      <prefix>"Account"="</prefix>
      <suffix>"</suffix>
      <default>*</default>
      <choice value="*">All</choice>
    </input>
    <input type="dropdown" token="field_application" searchWhenChanged="true">
      <label>Application</label>
      <search base="base_query">
        <query>| stats count by Application</query>
      </search>
      <fieldForLabel>Application</fieldForLabel>
      <fieldForValue>Application</fieldForValue>
      <prefix>Application="</prefix>
      <suffix>"</suffix>
      <choice value="*">All</choice>
      <default>*</default>
    </input>
    <input type="dropdown" token="filter_system" searchWhenChanged="true">
      <label>System</label>
      <search base="base_query">
        <query>| stats count by System</query>
      </search>
      <fieldForLabel>System</fieldForLabel>
      <fieldForValue>System</fieldForValue>
      <prefix>System="</prefix>
      <suffix>"</suffix>
      <choice value="*">All</choice>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <table>
        <search base="base_query">
          <query>
          | search $filter_system$
          | search $field_application$
          | search $field_account$
          </query>
        </search>
        <option name="count">20</option>
        <option name="showPager">true</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <option name="drilldown">cell</option>
        <drilldown>
          <condition match="isnotnull($row.Details$)">
            <eval token="tokCombined">$row.Details|n$$row.series|n$</eval>
            <link target="_blank">
              <![CDATA[$row.Details|n$$row.series|n$]]>
            </link>
          </condition>
          <condition field="*">
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
</dashboard>
